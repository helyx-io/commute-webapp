////////////////////////////////////////////////////////////////////////////////////
// Imports
////////////////////////////////////////////////////////////////////////////////////

var ClientJWTBearerStrategy = require('passport-oauth2-jwt-bearer').Strategy;

var config = require('../../conf/config');
var DB = require('../../lib/db');

var db = DB.schema('commute');


////////////////////////////////////////////////////////////////////////////////////
// Strategy
////////////////////////////////////////////////////////////////////////////////////

var clientJWTBearerStrategy = new ClientJWTBearerStrategy(
	function(claimSetIss, done) {
		new db.PemClient({ id: claimSetIss }).fetch().then((pemClient) => {
			if (!pemClient) {
				done(null, false);
			} else {
				done(null, pemClient);
			}
		}).catch((err) => {
			done(err);
		});
	}
);


////////////////////////////////////////////////////////////////////////////////////
// Exports
////////////////////////////////////////////////////////////////////////////////////

module.exports = clientJWTBearerStrategy;
