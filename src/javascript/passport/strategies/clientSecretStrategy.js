////////////////////////////////////////////////////////////////////////////////////
// Imports
////////////////////////////////////////////////////////////////////////////////////

var ClientPasswordStrategy = require('passport-oauth2-client-password');

var config = require('../../conf/config');
var DB = require('../../lib/db');
var db = DB.schema('commute');


////////////////////////////////////////////////////////////////////////////////////
// Strategy
////////////////////////////////////////////////////////////////////////////////////

var clientSecretStrategy = new ClientPasswordStrategy((clientId, clientSecret, done) => {
	new db.Client({ clientId: clientId }).fetch().then((client) => {
		if (err) {
			return done(err);
		}
		if (!client) {
			return done(null, false);
		}
		if (client.clientSecret !== clientSecret) {
			return done(null, false);
		}
		return done(null, client);
	}).catch((err) => {
		done(err);
	});
});


////////////////////////////////////////////////////////////////////////////////////
// Exports
////////////////////////////////////////////////////////////////////////////////////

module.exports = clientSecretStrategy;
