<!doctype html>
<html lang="fr" ng-app="gtfsApp">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

    <title>Helyx.io - Playground</title>
    <link href='//fonts.googleapis.com/css?family=Ubuntu:300,700' rel='stylesheet' type='text/css'>


    <link rel="stylesheet" href="/bower_components/foundation/css/foundation.css" />
    <link rel="stylesheet" href="/bower_components/foundation/css/normalize.css" />

    <link rel="stylesheet" href="/styles/app.css" />

    <script src="//maps.googleapis.com/maps/api/js?v=3.exp"></script>

    <script src="/bower_components/modernizr/modernizr.js"></script>
    <script src="/bower_components/jquery/dist/jquery.min.js"></script>
    <script src="/bower_components/foundation/js/foundation.min.js"></script>
    <script src="/bower_components/moment/min/moment.min.js"></script>
    <script src="/bower_components/angular/angular.min.js"></script>
    <script src="/bower_components/lodash/dist/lodash.min.js"></script>

    <script src="/scripts/app.js"></script>


    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />
    <meta name="application-name" content="Helyx.io"/>
    <meta name="msapplication-TileColor" content="#345D79" />
    <meta name="msapplication-TileImage" content="/mstile-144x144.png" />
</head>
<body>

<div id="content" ng-controller="AppController">

    <div id="header" ng-controller="HeaderController">

        <div id="settings" ng-controller="SettingsController">
            <button id="btn-calendar" class="selected" ng-click="toggleLeftSidebar()"><ng-include src="'/images/calendar48.svg'" alt="Calendar" /></button>
            <button id="btn-stops" class="selected" ng-click="toggleRightSidebar()"><ng-include src="'/images/two114.svg'" alt="stops" /></button>
            <button id="btn-settings"><ng-include src="'/images/settings20.svg'" alt="Settings" /></button>
        </div>

        <div id="header-date">
            <button id="btn-date-previous"><ng-include src="'/images/arrow395.svg'" alt="stops" /></button>
            <h1>{{date}}</h1>
            <button id="btn-date-next"><ng-include src="'/images/arrow396.svg'" alt="stops" /></button>
        </div>
    </div>

    <div id="main" ng-cloak ng-controller="MainController">

        <div id="sidebar-left" ng-show="showLeftSidebar">
            <div id="sidebar-left-content">
                <div id="sidebar-calendar-container" ng-cloak ng-controller="SidebarCalendarController">
                    <div id="sidebar-calendar">
                        <h1>Calendar</h1>
                        <div id="days">
                            <div id="day-{{index}}" ng-repeat="day in days" class="day {{day._class}}">
                                <aside>{{day.day}}</aside>
                                <h4>{{day.weekDay}}</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="sidebar-stops-container" ng-cloak ng-controller="SidebarStopsController">
                    <div id="sidebar-stops">
                        <h1>Stops</h1>
                        <div id="sidebar-stops-content">
                            <div id="sidebar-stop-row-{{index}}" ng-repeat="stop in stops" class="sidebar-stop {{stop._class}}">
                                <h4>{{stop.stop_name}} ({{stop.stop_id}})</h4>
                                <h5>{{stop.stop_desc}}</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="main-content">
            <div id="map" ng-cloak ng-controller="MapController">
                <div id="map-canvas"></div>
            </div>
        </div>

        <div id="sidebar-right">

            <div id="sidebar-right-content" ng-show="showRightSidebar">
                <div id="stops" ng-cloak ng-controller="StopsController">
                    <div id="stop-row-{{index}}" class="stop" ng-repeat="stop in stops" ng-controller="StopController">
                        <div class="stop-title">
                            <aside>{{(stop.stop_distance / 1000).toFixed(3)}} km</aside>
                            <h2>{{stop.stop_name}} ({{stop.stop_id}})</h2>
                            <h3>{{stop.stop_desc}} - <a href="{{stop.stop_loc_link}}" target="blank">Map</a></h3>
                        </div>
                        <div id="stop-time-{{stop.index}}" class="stop-content" ng-controller="StopLinesController">
                            <div class="line" ng-repeat="line in lines" ng-controller="StopLineController">
                                <div class="line-title">
                                    <aside style="background-color:#{{line.route_color}}; color:#{{line.route_text_color}};">{{line.name}}</aside>
                                    <h3>{{line.first_stop.stop_name}}</h3>
                                    <h4>{{line.last_stop.stop_name}}</h4>
                                </div>
                                <div class="line-content">
                                    <ul class="stop-times">
                                        <li ng-repeat="stop_time in line.stop_times">
                                            {{stop_time.arrival_time}}
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="footer">
        <h1>Copyright 2015 - Helyx.io</h1>
    </div>

</div>

<script>

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// Application
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    var gtfsApp = angular.module('gtfsApp', []);


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// Helper functions
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    function inherits(childCtor, parentCtor) {
        /* @constructor */
        function tempCtor() {}
        tempCtor.prototype = parentCtor.prototype;
        childCtor.superClass_ = parentCtor.prototype;
        childCtor.prototype = new tempCtor();
        /* @override */
        childCtor.prototype.constructor = childCtor;
    }


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// Factory
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    gtfsApp.factory('Globals', function() {

//        var config = { // St-Maurice
//            dataset: 'RATP_GTFS_FULL',
//            date: '2014-12-20' +
//            '', // moment().format("YYYY-MM-DD")
//            geo: {
//                lat: 48.814593,
//                lon: 2.4586253
//            },
//            distance: 1000,
//            locations: 1,
//            ignoreDay: 1
//        };

        var config = { // Renne
            dataset: 'STAR_GTFS_RENNES',
            date: '2015-01-15', // moment().format("YYYY-MM-DD")
            geo: {
                lat: 48.1089,
                lon: -1.47798
            },
            distance: 1000,
            locations: 1,
            ignoreDay: 0,
            stopId: '4152'
        };

        return {
            baseURL: location.hostname == 'localhost' ? 'http://localhost:9000' : 'http://gtfs.helyx.io',
            config: config
        };
    });

    gtfsApp.factory('CalendarService', function($http, $q, Globals) {
        var calendarService = {};

        var daysOfWeek = {
            1: "Monday",
            2: "Tuesday",
            3: "Wednesday",
            4: "Thursday",
            5: "Friday",
            6: "Saturday",
            7: "Sunday"
        };

        calendarService.dayOfWeekAsString = function(day) {
            return daysOfWeek[day];
        };

        calendarService.buildCalendar = function() {

            var defer = $q.defer();

            // Make it comparable with other built dates
            var today = moment(moment().format('YYYY-MM-DD'), 'YYYY-MM-DD');
            var selectedDate = moment(Globals.config.date, 'YYYY-MM-DD');

            var startOfCalendar = moment(today).add(-10, 'days');

            var days = [];

            var day = moment(startOfCalendar);
            for (var i = 0 ; i < 100 ; i++) {
                var dayClass = day.isSame(today) ? 'today' : (day.isSame(selectedDate) ? 'selected': '');
                days.push({ day: day.format('D'), weekDay: calendarService.dayOfWeekAsString(day.format('E')), date: day, _class: dayClass });
                day = moment(day).add(1, 'days');
            }

            defer.resolve(days);

            return defer.promise;
        };

        return calendarService;
    });

    gtfsApp.factory('StopService', function($http, $q, Globals) {
        var stopService = { };

        stopService.fetchStops = function(dataset, lat, lon, distance, locations) {

            if (stopService.stops) {
                var defer = $q.defer();
                defer.resolve(stopService.stops);
                return defer.promise;
            } else if (stopService.defer) {
                return stopService.defer.promise;
            }
            else {
                stopService.defer = $q.defer();

                var url = Globals.baseURL + '/api/agencies/' + dataset + '/stops/nearest?lat=' + lat + '&lon=' + lon + '&distance=' + distance + '&locations=' + locations;

                $http.get(url).success(function (stops, status, headers, config) {
                    stopService.stops = stops;
                    stopService.defer.resolve(stops);
                }).error(function (data, status, headers, config) {
                    stopService.defer.reject(new Error('HTTP error[' + status + ']'));
                });
            }

            return stopService.defer.promise;
        };

        return stopService;
    });

    gtfsApp.factory('LineService', function($http, $q, Globals) {
        var lineService = { };

        lineService.fetchStopTimes = function(dataset, stopId, date, ignoreDay) {
            var defer = $q.defer();

            var url = Globals.baseURL + '/api/agencies/' + dataset + '/stop-times-full/' + stopId + '/' + date + '?ignoreDay=' + ignoreDay;

            $http.get(url).success(function (stopTimes, status, headers, config) {
                defer.resolve(stopTimes);
            }).error(function (data, status, headers, config) {
                defer.reject(new Error('HTTP error[' + status + ']'));
            });

            return defer.promise;
        };

        return lineService;

    });

    gtfsApp.factory('TripService', function($http, $q, Globals) {
        var tripService = { };

        tripService.fetchStopTimes = function(dataset, tripId) {

            var defer = $q.defer();

            var url = Globals.baseURL + '/api/agencies/' + dataset + '/trips/' + tripId + '/stop-times';

            $http.get(url).success(function (stopTimes, status, headers, config) {
                defer.resolve(stopTimes);
            }).error(function (data, status, headers, config) {
                defer.reject(new Error('HTTP error[' + status + ']'));
            });

            return defer.promise;
        };

        return tripService;
    });


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// Position Marker
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    google.maps.PositionMarker = function($scope, map, position, options) {

        options = options || {};
        options.icon = options.icon ? options.icon : 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png';
        options.title = options.title ? options.title : 'Position';

        this.$scope = $scope;


        this.geocoder = new google.maps.Geocoder();

        this.infoWindow = new google.maps.InfoWindow();

        google.maps.Marker.apply(this, {});

        this.setOptions({ position: position, map: map, title: options.title, icon: options.icon });

        var self = this;
        google.maps.event.addListener(this, 'click', function() {
            self.show();
        });

    };

    inherits(google.maps.PositionMarker, google.maps.Marker);

    google.maps.PositionMarker.prototype.openInfoWindow = function() {

        if (this.infoWindow == this.$scope.openedInfoWindow) {
            return ;
        }

        if (this.$scope.openedInfoWindow) {
            this.$scope.openedInfoWindow.close();
        }

        this.$scope.openedInfoWindow = this.infoWindow;

        this.infoWindow.setContent(this.legend());

        this.infoWindow.open(this.map, this);

    };

    google.maps.PositionMarker.prototype.legend = function() {
        return "<b>Position" + '</b>' + (this.address() ? '<br>' + this.address() : '');
    };

    google.maps.PositionMarker.prototype.show = function() {
        var self = this;
        this.geocode(function() {
            self.openInfoWindow();
        });
    };

    google.maps.PositionMarker.prototype.geocode = function(done) {
        var self = this;

        if (self.geocoded) {
            done();
        }
        else {
            self.geocoder.geocode({ latLng: self.position }, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    if (results[0]) {
                        self.geocoded = true;
                        self.geocodingInfos = results;

                        done();
                    }
                }
            });
        }
    };

    google.maps.PositionMarker.prototype.address = function() {
        return this.geocodingInfos ? _.pluck(this.geocodingInfos[0].address_components, 'long_name').join(', ') : "";
    };


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// Position Marker
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    google.maps.StopMarker = function($scope, map, stop, options) {
        this.stop = stop;
        var stopPosition = new google.maps.LatLng(stop.stop_lat, stop.stop_lon);

        var options = { title: stop.stop_name, icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png' };
        google.maps.PositionMarker.apply(this, [$scope, map, stopPosition, options]);
    };

    inherits(google.maps.StopMarker, google.maps.PositionMarker);

    google.maps.StopMarker.legend = function() {
        var distance = (stop.stop_distance / 1000).toFixed(3);
        return '<b>' + stop.stop_name + '</b> - <i><small>' + distance + ' km</small></i>' + (stop.address ? '<br>' + stop.address : '');
    };


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    /// Controllers
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    gtfsApp.controller('AppController', function($rootScope, $scope, Globals) {
        $scope.showLeftSidebar = true;
        $scope.showRightSidebar = true;


        $scope.toggleLeftSidebar = function() {
            $scope.showLeftSidebar = !$scope.showLeftSidebar;

            var sidebarLeft = angular.element('#sidebar-left');
            var mainContent = angular.element('#main-content');

            if ($scope.showLeftSidebar) {
                mainContent.removeClass('left-full');
                sidebarLeft.removeClass('hidden');
            } else {
                mainContent.addClass('left-full');
                sidebarLeft.addClass('hidden');
            }

            $rootScope.$broadcast('redrawMapEvent');
        };

        $scope.toggleRightSidebar = function() {
            $scope.showRightSidebar = !$scope.showRightSidebar;

            var sidebarRight = angular.element('#sidebar-right');
            var mainContent = angular.element('#main-content');

            if ($scope.showRightSidebar) {
                mainContent.removeClass('right-full');
                sidebarRight.removeClass('hidden');
            } else {
                mainContent.addClass('right-full');
                sidebarRight.addClass('hidden');
            }

            $rootScope.$broadcast('redrawMapEvent');
        };

    });

    gtfsApp.controller('HeaderController', function($scope, Globals) {
        $scope.date = moment(Globals.config.date, "YYYY-MM-DD").format("DD/MM/YYYY");
    });

    gtfsApp.controller('SettingsController', function($scope, Globals) {

        $scope.toggleLeftSidebar = function() {
            $scope.$parent.toggleLeftSidebar();

            var btnCalendar = angular.element('#btn-calendar');

            if ($scope.showLeftSidebar) {
                btnCalendar.addClass('selected')
            } else {
                btnCalendar.removeClass('selected')
            }
        };

        $scope.toggleRightSidebar = function() {
            $scope.$parent.toggleRightSidebar();

            var btnStops = angular.element('#btn-stops');

            if ($scope.showRightSidebar) {
                btnStops.addClass('selected')
            } else {
                btnStops.removeClass('selected')
            }
        };
    });

    gtfsApp.controller('MainController', function($scope, Globals) {

        var mapElt = angular.element("#map");
        var stopsElt = angular.element('#stops');

        $scope.toggleMapVisibility = function() {
            if (stopsElt.hasClass('stop-hidden')) {
                stopsElt.removeClass('stop-hidden');
                mapElt.addClass('map-hidden');
            } else {
                stopsElt.addClass('stop-hidden');
                mapElt.removeClass('map-hidden');
            }
        };
    });

    gtfsApp.controller('SidebarCalendarController', function($scope, CalendarService) {
        $scope.days = [];

        CalendarService.buildCalendar().then(function(days) {
            $scope.days = days;
        });
    });

    gtfsApp.controller('SidebarStopsController', function($scope, $http, Globals, StopService) {

        $scope.stops = [];

        var config = Globals.config;

        StopService.fetchStops(config.dataset, config.geo.lat, config.geo.lon, config.distance, config.locations).then(function(stops) {
            $scope.stops = stops;

            $scope.stops.forEach(function (stop, index) {
                stop.index = index;
                stop._class = stop.stop_id == config.stopId ? 'selected' : '';
                stop.stop_loc_link = 'https://maps.google.com/maps?q=' + stop.stop_lat + ',' + stop.stop_lon
            });

        }).catch(function(err) {
            console.log(err);
        });

     });

    gtfsApp.controller('StopsController', function($scope, Globals, StopService) {

        $scope.stops = [];

        var config = Globals.config;

        StopService.fetchStops(config.dataset, config.geo.lat, config.geo.lon, config.distance, config.locations).then(function(stops) {

            $scope.stops = stops;

        }).catch(function(err) {
            console.log(err);
        });

    });

    gtfsApp.controller('StopController', function($scope, Globals, LineService) {

        $scope.lines = [];

        var config = Globals.config;

        LineService.fetchStopTimes(config.dataset, $scope.stop.stop_id, config.date, config.ignoreDay).then(function(lines) {
            lines.forEach(function(line) {
                if (line.stop_times.length > 0) {
                    line.trip_id = line.stop_times[0].trip_id;
                    line.route_color = line.stop_times[0].route_color;
                    line.route_text_color = line.stop_times[0].route_text_color;
                }
            });

            $scope.lines = lines;

        }).catch(function(err) {
            console.log(err);
        });

    });

    gtfsApp.controller('StopLinesController', function($scope) {

    });

    gtfsApp.controller('StopLineController', function($scope, Globals, TripService) {

        var config = Globals.config;

        TripService.fetchStopTimes(config.dataset, $scope.line.trip_id).then(function(stopTimes) {
            $scope.line.first_stop = stopTimes[0].stop;
            $scope.line.last_stop = stopTimes[stopTimes.length - 1].stop;
        }).catch(function(err) {
            console.log(err);
        });

    });

    gtfsApp.controller('MapController', function($rootScope, $scope, $q, Globals, StopService) {

        $scope.stops = [];

        var config = Globals.config;

        $scope.initialize = function() {

            StopService.fetchStops(config.dataset, config.geo.lat, config.geo.lon, config.distance, config.locations).then(function(stops) {

                $scope.stops = stops;


                ////////////////////////////////////////////////////////////////////////////////////////////////////////
                /// Map Init
                ////////////////////////////////////////////////////////////////////////////////////////////////////////

                var position = new google.maps.LatLng(Globals.config.geo.lat, Globals.config.geo.lon);

                var map = new google.maps.Map(document.getElementById('map-canvas'), { zoom: 17, center: position });

                $rootScope.$on('redrawMapEvent', function() {
                    google.maps.event.trigger(map,'resize')
                });


                ////////////////////////////////////////////////////////////////////////////////////////////////////////
                /// Position Marker
                ////////////////////////////////////////////////////////////////////////////////////////////////////////

                var positionMarker = new google.maps.PositionMarker($scope, map, position);

                positionMarker.show();


                ////////////////////////////////////////////////////////////////////////////////////////////////////////
                /// Stops Markers
                ////////////////////////////////////////////////////////////////////////////////////////////////////////

                $scope.stops.forEach(function(stop) {
                    new google.maps.StopMarker($scope, map, stop);
                });


            }).catch(function(err) {
                console.log(err);
            });

        };

        google.maps.event.addDomListener(window, 'load', $scope.initialize);
    });

</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1889791-26', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>
